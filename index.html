<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title></title>
</head>
<body>

	<script src="js/libs/jquery.min.js"></script>
	<script src="js/libs/tween.min.js"></script>
	<script src="js/libs/three.min.js"></script>
	<script src="js/loaders/OBJLoader.js"></script>
	<script src="js/loaders/ColladaLoader2.js"></script>
	<script src="js/controls/TrackballControls.js"></script>
	<script src="js/renderers/Projector.js"></script>
	<script src="js/renderers/CanvasRenderer.js"></script>
	<script src="js/libs/stats.min.js"></script>
	<script>

			var container;
			var camera, scene, renderer;
			var RAD_90  = 90/180*Math.PI;

			var teamMesh, teamMaterial;

			var missileDae;

			var missileLauncher = new THREE.Group();

			var missileVec = new THREE.Vector3(1,0,0);
			var launcherVec = new THREE.Vector3(-1,0,0);

			var teamsData = [];

			init();
			animate();


			function attack( startTeam , endTeam , time ){

				var missile = missileDae.clone();
				var quaternion = new THREE.Quaternion();
				var rotation = new THREE.Euler();

				var startPos 	= 	startTeam.core.position;
				var endPos 		= 	endTeam.core.position;
				var dx = endPos.x - startPos.x;
				var dy = endPos.y - startPos.y;
				var d = Math.sqrt(dx*dx+dy*dy);

				var targetVec = new THREE.Vector3(dx,dy,0);


				var offset = new THREE.Vector3(0,0,RAD_90);


				var trajectory = {
					curve :	 new THREE.SplineCurve3([
									    new THREE.Vector3(startPos.x, startPos.y, 100),
									    new THREE.Vector3(startPos.x + dx/3, startPos.y + dy/3, d/4), 
									    new THREE.Vector3(endPos.x - dx/3, endPos.y - dy/3, d/4),
									    new THREE.Vector3(endPos.x, endPos.y, 100)
									]),
					pos : 0
				}

				var geometry = new THREE.Geometry();
				geometry.vertices = trajectory.curve.getPoints(50);
				var material = new THREE.LineBasicMaterial({color : 0xee00ee});
				var line = new THREE.Line(geometry, material);

				scene.add( line );


				var tangent; 
				var launch = new TWEEN.Tween( trajectory )
														.to({pos:1},time)
														.onStart(function(){
															scene.add(missile);
															// startTeam.core.rotation.z = targetVec.angleTo(missileVec)-RAD_90;
															startTeam.core.children[1].visible = false;
															// setTimeout(setVisible(startTeam.core.children[1],true),1000);
															// console.log(startTeam.core);
														})
														.onUpdate(function(){
															missile.position.copy(trajectory.curve.getPointAt(trajectory.pos));
															tangent = trajectory.curve.getTangentAt(trajectory.pos).normalize();
															quaternion.setFromUnitVectors(missileVec , tangent);
															rotation.setFromQuaternion(quaternion,'XYZ');
															missile.rotation.set(rotation.x,rotation.y,rotation.z);

														})
														.onComplete(function(){
															scene.remove(missile);
															missile = null;
															scene.remove(line);
															line = null;
															startTeam.core.children[1].visible = true;
														});
				var rot = launcherVec.angleTo(targetVec);

				rot = dy > 0 ? -rot :rot;


				var aim = new TWEEN.Tween( startTeam.core.rotation )
														.to({z:rot},500)
														.onComplete(function(){
															launch.start();
														})
														.start();

			}

			function setVisible(obj,visible){
				obj.visible = visible;
			}

			function attactTest(){
				var startIndex = Math.ceil(Math.random()*15);
				var endIndex;
				do{
					endIndex = Math.ceil(Math.random()*15);
				}while(endIndex == startIndex);
				attack(teamsData[startIndex],teamsData[endIndex],1800);
				var time = Math.ceil(Math.random()*3000);
				setTimeout(attactTest,time);
			}


			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( 0, -1800, 1000 );
				camera.rotation.x = 90/180*Math.PI;
				camera.lookAt( new THREE.Vector3() );

				scene = new THREE.Scene();


				controls = new THREE.TrackballControls( camera , container );
				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;
				controls.noZoom = false;
				controls.noPan = false;
				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );


				var loader = new THREE.ColladaLoader();

				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
							var percentComplete = xhr.loaded / xhr.total * 100;
							console.log( Math.round(percentComplete, 2) + '% downloaded' );
					}
				};

				var onError = function ( xhr ) {
				};

				// roll-over helpers

				teamGeo = new THREE.BoxGeometry( 50, 50, 50 );
				teamMaterial = new THREE.MeshBasicMaterial( { color: 0xffff00 } );
				teamMesh = new THREE.Mesh( teamGeo, teamMaterial );

				// var flagGeo = new THREE.BoxGeometry( 3, 3, 500 );
				// var flagMaterial = new THREE.MeshBasicMaterial( { color: 0x000000 } );
				
				var flagGeo = new THREE.BoxGeometry( 5, 5, 375 );
				var flagMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x111111, shininess: 100 } );
				var flagMesh = new THREE.Mesh( flagGeo, flagMaterial );



				loader.load( 'models/missileLauncherP1.dae', function ( collada ) {
					var p1 = collada.scene;
					p1.traverse( function ( child ) {
						if ( child instanceof THREE.SkinnedMesh ) {
								var animation = new THREE.Animation( child, child.geometry.animation );
								animation.play();
							}
					});
					// launcher.position.set(0,0,0);
					p1.scale.set(20,20,20);
					p1.rotation.x = 0;

					loader.load( 'models/missileLauncherP2.dae', function ( collada ) {
						var p2 = collada.scene;
						p2.traverse( function ( child ) {
							if ( child instanceof THREE.SkinnedMesh ) {
									var animation = new THREE.Animation( child, child.geometry.animation );
									animation.play();
								}
						});
						p2.scale.set(20,20,20);
						p2.rotation.x = 0;

						missileLauncher.add(p1);
						missileLauncher.add(p2);
						// scene.add(missileLauncher);

						for(var i=0;i<16;i++){
							var newMesh = missileLauncher.clone();
							var flag = flagMesh.clone();
							newMesh.position.set(-900+(i%4)*600,-900+Math.floor(i/4)*600,0);
							flag.position.copy(newMesh.position);
							newMesh.rotation.z = Math.random()*RAD_90*4;
							scene.add(newMesh);
							scene.add(flag);

							teamsData[i]={
								core:newMesh,
								logo:null,
								HP:100,
								currentHP:100,
								position:newMesh.position
							}
						}

						loader.load( 'models/missile.dae', function ( collada ) {
							missileDae = collada.scene;
							missileDae.traverse( function ( child ) {
								if ( child instanceof THREE.SkinnedMesh ) {
										var animation = new THREE.Animation( child, child.geometry.animation );
										animation.play();
									}
							});
							missileDae.scale.set(20,20,20);
							missileDae.rotation.x = 0;
							attactTest();
						}, onProgress, onError);

					}, onProgress, onError);

				}, onProgress, onError);


				// grid

				var size = 1000, step = 50;

				var geometry = new THREE.Geometry();

				for ( var i = - size; i <= size; i += step ) {

					geometry.vertices.push( new THREE.Vector3( - size, i, 0 ) );
					geometry.vertices.push( new THREE.Vector3(   size, i, 0 ) );

					geometry.vertices.push( new THREE.Vector3( i, - size, 0 ) );
					geometry.vertices.push( new THREE.Vector3( i,   size, 0 ) );

				}

				var material = new THREE.LineBasicMaterial( { color: 0x000000, opacity: 0.2, transparent: true } );

				var line = new THREE.LineSegments( geometry, material );
				scene.add( line );

				//



				// Lights

				var ambientLight = new THREE.AmbientLight( 0x606060 );
				scene.add( ambientLight );

				var directionalLight = new THREE.DirectionalLight( 0xffffff );
				directionalLight.position.set( 1, 0.75, 0.5 ).normalize();
				scene.add( directionalLight );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setClearColor( 0xf0f0f0 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );

			}


			function animate() {

				requestAnimationFrame( animate );
				render();

			}


			function render() {

				controls.update();
				TWEEN.update();
				stats.update();
				renderer.render( scene, camera );

			}

	</script>
</body>
</html>